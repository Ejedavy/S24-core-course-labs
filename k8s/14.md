# Lab 14: Kubernetes Cluster Monitoring With Prometheus

## Components Description
### Prometheus Operator
The Prometheus Operator streamlines the deployment and management processes for Prometheus, Alertmanager, and associated monitoring components.

### Highly Available Prometheus
This configuration of Prometheus reliably stores metrics as time series data, ensuring high availability for consistent metric collection.

### Highly Available Alertmanager
Alertmanager effectively handles notifications from client applications with features such as:
- **Grouping:** Merges several alerts into a single notification.
- **Inhibition:** Prevents specific alerts from triggering during ongoing incidents.
- **Silences:** Disables alerts temporarily.
- **Client Behavior and High Availability:** Offers customization through `cluster-*` flags to enhance stability.

### Prometheus Node-Exporter
Node-Exporter gathers and exports system and hardware metrics, which are then ingested by Prometheus.

### Prometheus Blackbox-Exporter
This utility assesses the latency of various network services (HTTP/S, TCP, ICMP, DNS) and produces metrics reflecting their operational status.

### Prometheus Adapter for Kubernetes Metrics APIs
This service transforms metrics stored in Prometheus into a format accessible via Kubernetes metrics APIs, facilitating their integration.

### Kube-State-Metrics
This daemon monitors the Kubernetes API server, producing metrics about the status and configuration of its resources.

### Grafana
Grafana provides tools to visualize, query, and set alerts on data from diverse sources, enhancing data understanding and monitoring.

```shell
davideje@Davids-MacBook-Pro S24-core-course-labs % kubectl get po,sts,svc,pvc,cm
NAME                                                                  READY   STATUS    RESTARTS        AGE
pod/alertmanager-prometheus-my-helm-app-pyt-alertmanager-0            2/2     Running   0               5m59s
pod/app-python-helm-app-python-0                                      1/1     Running   10 (4d6h ago)   6d20h
pod/app-python-helm-app-python-1                                      1/1     Running   13 (4d6h ago)   6d20h
pod/prometheus-my-helm-app-pyt-operator-8588d97b46-snnh2              1/1     Running   0               6m21s
pod/prometheus-my-helm-app-python-grafana-6454d9f9f-9sct2             3/3     Running   0               6m21s
pod/prometheus-my-helm-app-python-kube-state-metrics-787f489664f4xl   1/1     Running   0               6m21s
pod/prometheus-my-helm-app-python-prometheus-node-exporter-mzt9k      1/1     Running   0               6m21s
pod/prometheus-prometheus-my-helm-app-pyt-prometheus-0                2/2     Running   0               5m59s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-prometheus-my-helm-app-pyt-alertmanager   1/1     5m59s
statefulset.apps/app-python-helm-app-python                             2/2     6d20h
statefulset.apps/prometheus-prometheus-my-helm-app-pyt-prometheus       1/1     5m59s

NAME                                                             TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                                    ClusterIP      None             <none>        9093/TCP,9094/TCP,9094/UDP   5m59s
service/app-python-helm-app-python                               LoadBalancer   10.111.229.120   <pending>     8000:31313/TCP               6d20h
service/kubernetes                                               ClusterIP      10.96.0.1        <none>        443/TCP                      20d
service/prometheus-my-helm-app-pyt-alertmanager                  ClusterIP      10.107.137.19    <none>        9093/TCP,8080/TCP            6m22s
service/prometheus-my-helm-app-pyt-operator                      ClusterIP      10.100.120.189   <none>        443/TCP                      6m22s
service/prometheus-my-helm-app-pyt-prometheus                    ClusterIP      10.103.131.145   <none>        9090/TCP,8080/TCP            6m22s
service/prometheus-my-helm-app-python-grafana                    ClusterIP      10.105.178.30    <none>        80/TCP                       6m22s
service/prometheus-my-helm-app-python-kube-state-metrics         ClusterIP      10.111.96.29     <none>        8080/TCP                     6m22s
service/prometheus-my-helm-app-python-prometheus-node-exporter   ClusterIP      10.101.99.125    <none>        9100/TCP                     6m22s
service/prometheus-operated                                      ClusterIP      None             <none>        9090/TCP                     5m59s

NAME                                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/mydata-app-python-helm-app-python-0   Bound    pvc-2f796fa9-074c-4a67-9034-aacd925426b9   1Gi        RWO            standard       6d20h
persistentvolumeclaim/mydata-app-python-helm-app-python-1   Bound    pvc-28ad70a8-33c7-4fb5-b7b4-00c7b8a91857   1Gi        RWO            standard       6d20h

NAME                                                                     DATA   AGE
configmap/configmap                                                      1      6d20h
configmap/kube-root-ca.crt                                               1      20d
configmap/prometheus-my-helm-app-pyt-alertmanager-overview               1      6m22s
configmap/prometheus-my-helm-app-pyt-apiserver                           1      6m22s
configmap/prometheus-my-helm-app-pyt-cluster-total                       1      6m22s
configmap/prometheus-my-helm-app-pyt-controller-manager                  1      6m22s
configmap/prometheus-my-helm-app-pyt-etcd                                1      6m22s
configmap/prometheus-my-helm-app-pyt-grafana-datasource                  1      6m22s
configmap/prometheus-my-helm-app-pyt-grafana-overview                    1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-coredns                         1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-resources-cluster               1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-resources-multicluster          1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-resources-namespace             1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-resources-node                  1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-resources-pod                   1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-resources-workload              1      6m22s
configmap/prometheus-my-helm-app-pyt-k8s-resources-workloads-namespace   1      6m22s
configmap/prometheus-my-helm-app-pyt-kubelet                             1      6m22s
configmap/prometheus-my-helm-app-pyt-namespace-by-pod                    1      6m22s
configmap/prometheus-my-helm-app-pyt-namespace-by-workload               1      6m22s
configmap/prometheus-my-helm-app-pyt-node-cluster-rsrc-use               1      6m22s
configmap/prometheus-my-helm-app-pyt-node-rsrc-use                       1      6m22s
configmap/prometheus-my-helm-app-pyt-nodes                               1      6m22s
configmap/prometheus-my-helm-app-pyt-nodes-darwin                        1      6m22s
configmap/prometheus-my-helm-app-pyt-persistentvolumesusage              1      6m22s
configmap/prometheus-my-helm-app-pyt-pod-total                           1      6m22s
configmap/prometheus-my-helm-app-pyt-prometheus                          1      6m22s
configmap/prometheus-my-helm-app-pyt-proxy                               1      6m22s
configmap/prometheus-my-helm-app-pyt-scheduler                           1      6m22s
configmap/prometheus-my-helm-app-pyt-workload-total                      1      6m22s
configmap/prometheus-my-helm-app-python-grafana                          1      6m22s
configmap/prometheus-my-helm-app-python-grafana-config-dashboards        1      6m22s
configmap/prometheus-prometheus-my-helm-app-pyt-prometheus-rulefiles-0   35     5m59s
```

## Kubernetes Cluster Summary

### Overview
The output from `kubectl get po,sts,svc,pvc,cm` provides a snapshot of the various resources managed in the Kubernetes environment, particularly those related to a Prometheus-based monitoring setup.

### Pods
- **Alertmanager, Prometheus, Grafana, and related services** are all running, indicating a healthy state of the monitoring infrastructure.
- **Application Pods** (app-python-helm-app-python) are running but have experienced several restarts a few days ago.

### StatefulSets
- Deployments for **Alertmanager** and **Prometheus** are stable with a desired state matching the current state, suggesting successful orchestration and no pending updates.

### Services
- A mix of **ClusterIP** and **LoadBalancer** services facilitate communication and accessibility of services within and potentially outside the cluster.
- Most services do not expose an external IP, focusing on internal cluster communication.

### PersistentVolumeClaims
- Persistent storage is in use for application data, with all volumes currently bound and operational.

### ConfigMaps
- A significant number of **ConfigMaps** are present, providing configurations for various cluster components and Prometheus monitoring setups.
- This includes settings for service discovery, metrics scraping, dashboards, and alert rules.


## GRAFANA
### CPU and Memory consumption
0.01% CPU time, and 39.7 MiB memory
[![telegram-cloud-photo-size-4-5893143409189830560-y.jpg](https://i.postimg.cc/vHrphfMC/telegram-cloud-photo-size-4-5893143409189830560-y.jpg)](https://postimg.cc/jLjgdWDh)

#### Pods with higher and lower CPU usage in the default namespace
Pod with highest cpu usage: prometheus
Pod with lowest cpu usage: alertmanager
[![telegram-cloud-photo-size-4-5893143409189830562-y.jpg](https://i.postimg.cc/bNPzqzvc/telegram-cloud-photo-size-4-5893143409189830562-y.jpg)](https://postimg.cc/F1PtZXcD)

#### Node memory usage in percentage and megabytes
61.1%
[![telegram-cloud-photo-size-4-5893143409189830564-y.jpg](https://i.postimg.cc/c4zXQJtP/telegram-cloud-photo-size-4-5893143409189830564-y.jpg)](https://postimg.cc/vcWrybzv)

#### Number of pods and containers managed by the Kubelet service
16 pods and 24 containers
[![telegram-cloud-photo-size-4-5893143409189830565-y.jpg](https://i.postimg.cc/T2DjWXX3/telegram-cloud-photo-size-4-5893143409189830565-y.jpg)](https://postimg.cc/SjmYw3sB)

#### Network usage of Pods in the default namespace 
36.4 kB/s for download, 21.6 kB/s for upload
[![telegram-cloud-photo-size-4-5893143409189830567-y.jpg](https://i.postimg.cc/SQBBWq2T/telegram-cloud-photo-size-4-5893143409189830567-y.jpg)](https://postimg.cc/t7zvjKzW)

#### Number of active alerts
9 
[![telegram-cloud-photo-size-4-5893143409189830568-y.jpg](https://i.postimg.cc/7ZFJ45f1/telegram-cloud-photo-size-4-5893143409189830568-y.jpg)](https://postimg.cc/sMJg9DP1)
**Web User Interface**
[![telegram-cloud-photo-size-4-5893143409189830569-y.jpg](https://i.postimg.cc/85jCrDJk/telegram-cloud-photo-size-4-5893143409189830569-y.jpg)](https://postimg.cc/G8nRZWx6)



## TASK 2

``` bash
davideje@Davids-MacBook-Pro k8s % kubectl exec app-python-helm-app-python-0 -- cat /init-dir/index.html

Defaulted container "helm-app-python" out of: helm-app-python, install (init)
<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="robots" content="noindex"><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="theme-color" content="#ffffff"/><meta name="description" content="Sauce Labs Swag Labs app"/><link rel="apple-touch-icon" href="/icon/icon-192x192.png"/><link rel="manifest" href="/manifest.json"/><script type="text/javascript">!function(n){if("/"===n.search[1]){var a=n.search.slice(1).split("&").map((function(n){return n.replace(/~and~/g,"&")})).join("?");window.history.replaceState(null,null,n.pathname.slice(0,-1)+a+n.hash)}}(window.location)</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500"><title>Swag Labs</title><link href="/static/css/main.d9c3792d.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"></div><script>!function(e){function r(r){for(var n,p,l=r[0],a=r[1],f=r[2],c=0,s=[];c<l.length;c++)p=l[c],Object.prototype.hasOwnProperty.call(o,p)&&o[p]&&s.push(o[p][0]),o[p]=0;for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n]);for(i&&i(r);s.length;)s.shift()();return u.push.apply(u,f||[]),t()}function t(){for(var e,r=0;r<u.length;r++){for(var t=u[r],n=!0,l=1;l<t.length;l++){var a=t[l];0!==o[a]&&(n=!1)}n&&(u.splice(r--,1),e=p(p.s=t[0]))}return e}var n={},o={1:0},u=[];function p(r){if(n[r])return n[r].exports;var t=n[r]={i:r,l:!1,exports:{}};return e[r].call(t.exports,t,t.exports,p),t.l=!0,t.exports}p.m=e,p.c=n,p.d=function(e,r,t){p.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},p.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},p.t=function(e,r){if(1&r&&(e=p(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(p.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var n in e)p.d(t,n,function(r){return e[r]}.bind(null,n));return t},p.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return p.d(r,"a",r),r},p.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},p.p="/";var l=this["webpackJsonpsample-app-web"]=this["webpackJsonpsample-app-web"]||[],a=l.push.bind(l);l.push=r,l=l.slice();for(var f=0;f<l.length;f++)r(l[f]);var i=a;t()}([])</script><script src="/static/js/2.c39c1971.chunk.js"></script><script src="/static/js/main.9e1f7694.chunk.js"></script></body></html>
```