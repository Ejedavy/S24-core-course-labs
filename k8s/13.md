# Lab 13: Kubernetes StatefulSet

```shell
davideje@Davids-MacBook-Pro k8s % helm install --dry-run --debug app-python ./helm-app-python   
install.go:218: [debug] Original chart version: ""
install.go:235: [debug] CHART PATH: /Users/davideje/School/Fall_24/Devops/S24-core-course-labs/k8s/helm-app-python

NAME: app-python
LAST DEPLOYED: Tue Apr 30 01:42:30 2024
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
password: ENC[AES256_GCM,data:zQCzA3EonNL+,iv:8pfD1Ozk8yRLEnTWMrZry6Aw/f+86TAXFv+VqIy9puw=,tag:xEKzznyUCjsB925C0fIidQ==,type:str]
sops:
  age: []
  azure_kv: []
  gcp_kms: []
  hc_vault: []
  kms: []
  lastmodified: "2024-04-16T20:20:56Z"
  mac: ENC[AES256_GCM,data:/Whh9OwbyelmUyzLftslaSAuVlEqjdZ95YltqFPHcuGfUJ/jpdsHpvOrImitPzdBZ7F4pVL43SFChYUqZ+ONDSa7X/NdQD2bSRKKmdPPaIFOQ0e8lfPIJ3Kq1jZsd3VqHD3sC0gxrMIFeOeE0v+bdCuO6pok8GutCx19ybcOqBE=,iv:5uAzqiD33DMEFOFtn+Dpg/BcQod1nuRIcSe9pI19YNw=,tag:ZLeidjrvwR5tsxbXJeW6nw==,type:str]
  pgp:
  - created_at: "2024-04-16T20:19:59Z"
    enc: |-
      -----BEGIN PGP MESSAGE-----

      hF4DfevrcXvqjuwSAQdA2jK43dfw8ubih3vAgBY8nKNKb48yp/cZKIL3A4eEcyMw
      x0G1pAYpBKEewyIMtPkVskdn3kcGFn0EowvRKkcIdAbq7XIaEgIPhSos/HIbX2lh
      1GYBCQIQqxmkhBwspQ1/WNKaGEhcTkSNgekO0Wekp2Rwp0R+gUhENCw8WAQ6KUHJ
      w7XpRanx9mCNtg6Lc0KNZ9OQNOhncHYc+Hf/58N1bKNEBOvEfTpQo3eTGEt2jkd9
      Ps2J6I//PJY=
      =X28u
      -----END PGP MESSAGE-----
    fp: 39A5D96291F027B8CE0B0F459565578429F8E7DB
  unencrypted_suffix: _unencrypted
  version: 3.8.1

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: ejedavid/app_python
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
livenessProbe:
  httpGet:
    path: /
    port: http
nameOverride: ""
nodeSelector: {}
password: ENC[AES256_GCM,data:zQCzA3EonNL+,iv:8pfD1Ozk8yRLEnTWMrZry6Aw/f+86TAXFv+VqIy9puw=,tag:xEKzznyUCjsB925C0fIidQ==,type:str]
podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/agent-inject-template-database-config.txt: |
    {{- with secret "internal/data/database/config" -}}
    postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
    {{- end -}}
  vault.hashicorp.com/role: internal-app
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 2
resources: {}
securityContext: {}
service:
  port: 8000
  type: LoadBalancer
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: internal-app
sops:
  age: []
  azure_kv: []
  gcp_kms: []
  hc_vault: []
  kms: []
  lastmodified: "2024-04-16T20:20:56Z"
  mac: ENC[AES256_GCM,data:/Whh9OwbyelmUyzLftslaSAuVlEqjdZ95YltqFPHcuGfUJ/jpdsHpvOrImitPzdBZ7F4pVL43SFChYUqZ+ONDSa7X/NdQD2bSRKKmdPPaIFOQ0e8lfPIJ3Kq1jZsd3VqHD3sC0gxrMIFeOeE0v+bdCuO6pok8GutCx19ybcOqBE=,iv:5uAzqiD33DMEFOFtn+Dpg/BcQod1nuRIcSe9pI19YNw=,tag:ZLeidjrvwR5tsxbXJeW6nw==,type:str]
  pgp:
  - created_at: "2024-04-16T20:19:59Z"
    enc: |-
      -----BEGIN PGP MESSAGE-----

      hF4DfevrcXvqjuwSAQdA2jK43dfw8ubih3vAgBY8nKNKb48yp/cZKIL3A4eEcyMw
      x0G1pAYpBKEewyIMtPkVskdn3kcGFn0EowvRKkcIdAbq7XIaEgIPhSos/HIbX2lh
      1GYBCQIQqxmkhBwspQ1/WNKaGEhcTkSNgekO0Wekp2Rwp0R+gUhENCw8WAQ6KUHJ
      w7XpRanx9mCNtg6Lc0KNZ9OQNOhncHYc+Hf/58N1bKNEBOvEfTpQo3eTGEt2jkd9
      Ps2J6I//PJY=
      =X28u
      -----END PGP MESSAGE-----
    fp: 39A5D96291F027B8CE0B0F459565578429F8E7DB
  unencrypted_suffix: _unencrypted
  version: 3.8.1
tolerations: []
volumeClaimTemplates:
- metadata:
    name: mydata
  spec:
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: 1Gi
volumeMounts:
- mountPath: /config
  name: configmap-volume
  readOnly: true
volumes:
- configMap:
    name: configmap
  name: configmap-volume

HOOKS:
---
# Source: helm-app-python/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: postinstall-hook
   annotations:
       "helm.sh/hook": "post-install"
       "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: post-install-container
    image: busybox
    imagePullPolicy: Always
    command: ['sh', '-c', 'echo The post-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: helm-app-python/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: preinstall-hook
   annotations:
       "helm.sh/hook": "pre-install"
       "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: pre-install-container
    image: busybox
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The pre-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: helm-app-python/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "app-python-helm-app-python-test-connection"
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['app-python-helm-app-python:8000']
  restartPolicy: Never
MANIFEST:
---
# Source: helm-app-python/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: internal-app
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: helm-app-python/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: credentials
type: Opaque
data:
  password: "RU5DW0FFUzI1Nl9HQ00sZGF0YTp6UUN6QTNFb25OTCssaXY6OHBmRDFPems4eVJMRW5UV01yWnJ5NkF3L2YrODZUQVhGditWcUl5OXB1dz0sdGFnOnhFS3p6bnlVQ2pzQjkyNUMwZklpZFE9PSx0eXBlOnN0cl0="
---
# Source: helm-app-python/templates/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: configmap
data:
  config.json: |-
    {
        "name": "david"
    }
---
# Source: helm-app-python/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: app-python-helm-app-python
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: LoadBalancer
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: app-python
---
# Source: helm-app-python/templates/statefulset.yml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: app-python-helm-app-python
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: helm-app-python
      app.kubernetes.io/instance: app-python
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-template-database-config.txt: |
          {{- with secret "internal/data/database/config" -}}
          postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
          {{- end -}}
        vault.hashicorp.com/role: internal-app
      labels:
        helm.sh/chart: helm-app-python-0.1.0
        app.kubernetes.io/name: helm-app-python
        app.kubernetes.io/instance: app-python
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: internal-app
      securityContext:
        {}
      containers:
        - name: helm-app-python
          securityContext:
            {}
          image: "ejedavid/app_python:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: MY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: credentials
                  key: password
          envFrom:
            - configMapRef:
                name: configmap
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          resources:
            {}
          volumeMounts:
            - mountPath: /config
              name: configmap-volume
              readOnly: true
      volumes:
        - configMap:
            name: configmap
          name: configmap-volume
  volumeClaimTemplates:
    - metadata:
        name: mydata
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi

NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w app-python-helm-app-python'
  export SERVICE_IP=$(kubectl get svc --namespace default app-python-helm-app-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:8000
```

```shell
davideje@Davids-MacBook-Pro k8s % kubectl get po                                                      
NAME                           READY   STATUS    RESTARTS   AGE
app-python-helm-app-python-0   1/1     Running   0          51s
app-python-helm-app-python-1   1/1     Running   0          47s
```


```shell
davideje@Davids-MacBook-Pro k8s % kubectl get po,sts,svc,pvc                                                                 
NAME                               READY   STATUS    RESTARTS   AGE
pod/app-python-helm-app-python-0   1/1     Running   0          109s
pod/app-python-helm-app-python-1   1/1     Running   0          105s

NAME                                          READY   AGE
statefulset.apps/app-python-helm-app-python   2/2     109s

NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/app-python-helm-app-python   LoadBalancer   10.111.229.120   <pending>     8000:31313/TCP   109s
service/kubernetes                   ClusterIP      10.96.0.1        <none>        443/TCP          13d

NAME                                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/mydata-app-python-helm-app-python-0   Bound    pvc-2f796fa9-074c-4a67-9034-aacd925426b9   1Gi        RWO            standard       109s
persistentvolumeclaim/mydata-app-python-helm-app-python-1   Bound    pvc-28ad70a8-33c7-4fb5-b7b4-00c7b8a91857   1Gi        RWO            standard       105s
```


```shell
davideje@Davids-MacBook-Pro k8s % minikube service app-python-helm-app-python
|-----------|----------------------------|-------------|---------------------------|
| NAMESPACE |            NAME            | TARGET PORT |            URL            |
|-----------|----------------------------|-------------|---------------------------|
| default   | app-python-helm-app-python | http/8000   | http://192.168.49.2:31313 |
|-----------|----------------------------|-------------|---------------------------|
🏃  Starting tunnel for service app-python-helm-app-python.
|-----------|----------------------------|-------------|------------------------|
| NAMESPACE |            NAME            | TARGET PORT |          URL           |
|-----------|----------------------------|-------------|------------------------|
| default   | app-python-helm-app-python |             | http://127.0.0.1:54187 |
|-----------|----------------------------|-------------|------------------------|
🎉  Opening service default/app-python-helm-app-python in default browser...
❗  Because you are using a Docker driver on darwin, the terminal needs to be open to run it.
```

[![image.png](https://i.postimg.cc/zB0pMySb/image.png)](https://postimg.cc/S2YWYNPk)


```shell
davideje@Davids-MacBook-Pro S24-core-course-labs % kubectl exec pod/app-python-helm-app-python-0 -- cat visits/visits.txt
147     
```

```shell
davideje@Davids-MacBook-Pro S24-core-course-labs % kubectl exec pod/app-python-helm-app-python-1 -- cat visits/visits.txt
159    
```

## Describe and explain differences in the report.
The numbers are different because each pod has its own state.

## Explain why ordering guarantees are unnecessary for your app.
The apps we have are independent of each other meaning that no data is shared between them so we can scale the replicas without dependency on ordering guarantees.
